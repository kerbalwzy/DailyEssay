## Django项目中使用定时任务

#### 1.为什么要使用定时任务?

```
在WEB项目的开发中,我们常常用尽各种方式来提高后台的服务能力.例如,使用缓存、集群部署、数据库读写分离等等.其中有一种方式就是“页面静态化”!
何为“页面静态化”「主要是使用在前后端分离的WEB项目中」?

通俗理解:将网页上的不经常变动的数据写死在HTML页面上,而不是每次请求这个网页都要向后端请求这个部分的数据
优点:可以减少前端对我们后端服务的访问次数,节省我们的后端段的计算和网络资源.
缺点:当页面上的这部分数据有变动时怎么办?难道每次都手动重写这个html页面上的这部分内容么?
解决办法:
	开启定时任务, 每隔一定的时间去调用一个功能代码,对这个页面进行重新渲染,替换原来的页面.这样当网页上的这部分数据在后端的存储中真的有变动时,也能自动的在网页上进行更新,当然从数据变动时间到定时任务执行时间这段的延迟时间是不可避免的.那么我们可以通过提高定时任务的执行频率来缩短这种延时,也可以通过其他方式对数据监控来手动触发这个定时任务要执行的代码
```

#### 2.Django中使用定时任务

- 1.在终端中输入下面👇的命令,检查你的ubuntu中是否已经安装了`crontab`,并且服务已经启动.因为定时任务最终还是落到了系统中一个叫做crontab的软件去执行

  ```shell
  # 查看是否启动👇
  sudo service cron status
  
  # 如果没有启动服务,请用下面命令启动👇
  sudo service cron start
  ```

- 2.安装`django-crontab`扩展包

  ```shell
  pip3 install django-crontab
  ```

- 3.在你的项目`配置文件`中修改或添加如下内容:

  ```python
  INSTALLED_APPS = [
      ...
      'django_crontab',  # 注册定时任务的应用
      ...
  ]
  
  # 添加定时任务的列表
  CRONJOBS = [
      # 每5分钟执行一次生成主页静态文件,并将执行过程中的日志信息输出到指定文件
      # 因为定任务是以守护进程的模式在后台默默运行,所以你想要来了解任务的执行情况必须使用日志
      ('*/5 * * * *', '你需要执行的功能代码的导包路径', '>> 你要保存日志的文件路径'),
      
      ('''更多定时任务''')
  ]
  
  # 解决crontab中文问题
  CRONTAB_COMMAND_PREFIX = 'LANG_ALL=zh_cn.UTF-8'
  ```

- 4.接下来你就可以通过下面👇这些命令来添加、查看、删除定时任务了

  ```shell
  # 将Django项目中配置的定时任务添加到系统的crontab中
  python manage.py crontab add
  
  # 查看已经添加、并激活的定时任务
  python manage.py crontab show
  
  # 删除Django项目中配置的定时任务
  python manage.py crontab remove
  ```

- 5.你在项目中通过配置文件添加的定时任务真的到系统的crontab中去了么?

  ```shell
  # 你可以在终端中通过下面的命令查看现在系统中的所有定时任务
  crontab -l
  
  # 你还可以通过下面的命令自己添加定时任务
  # 第一次使用时可能需要你选择编辑器,然后在定时任务文件中添加你的定时任务,文件中有demo,参照添加就行
  crontab -e
  ```
